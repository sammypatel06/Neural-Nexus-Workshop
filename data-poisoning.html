<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Challenge #5 – Data Poisoning Demo</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-img: url("pictures/stone-wall.jpg");
        --text-color: #e3d8b4;
        --accent-color: #b08d4e;
        --input-bg: #3a2f1c;
        --input-border: #5d4b2e;
        --fade-start: 70%;
      }
      body {
        margin: 0;
        font-family: "Cinzel", serif;
        color: var(--text-color);
        background: var(--bg-img) center/cover fixed;
        position: relative;
        overflow-y: auto;
      }
      body::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.1) var(--fade-start),
          rgba(0, 0, 0, 1)
        );
        pointer-events: none;
      }
      body::after {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        pointer-events: none;
      }
      .content {
        position: relative;
        z-index: 2;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: start;
        padding: 5rem 1rem;
        text-align: center;
      }
      .scenario-text,
      .instructions {
        font-size: 1.4rem;
        max-width: 800px;
        margin-bottom: 1.2rem;
      }
      table {
        margin: auto;
        border-collapse: collapse;
        width: 90%;
        max-width: 800px;
        margin-top: 1rem;
        font-size: 0.95rem;
        color: #eee;
      }
      th,
      td {
        padding: 0.3rem 0.6rem;
        border-bottom: 1px solid #555;
      }
      th {
        background: rgba(0, 0, 0, 0.3);
      }
      .btn {
        background: var(--accent-color);
        border: none;
        padding: 0.4rem 0.8rem;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        border-radius: 3px;
        margin-top: 0.5rem;
      }
      .btn:hover {
        opacity: 0.9;
      }
      .progress-bar {
        width: 80%;
        max-width: 600px;
        height: 8px;
        background: #444;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.8rem;
      }
      #progressBar {
        height: 100%;
        background: #4caf50;
        width: 0%;
      }
      .prompt-input {
        width: 80%;
        max-width: 520px;
        padding: 0.8rem 1rem;
        font-size: 1rem;
        color: #fff;
        background-color: var(--input-bg);
        border: 1px solid var(--input-border);
        border-radius: 4px;
        outline: none;
        margin-top: 0.5rem;
      }
      .prompt-input::placeholder {
        color: #c0b68e;
      }
      #flagSection {
        display: none;
        margin-top: 1rem;
      }
      .flag {
        color: #4caf50;
        font-weight: bold;
        margin-top: 0.8rem;
      }
    </style>
  </head>

  <body>
    <div class="content">
      <!-- Title -->
      <h1>Challenge #5 – Data Poisoning Demo</h1>

      <!-- Scenario -->
      <p class="scenario-text">
        You find yourself in a dimly lit alchemy laboratory. Shelves of dusty
        bottles line the walls, and an ancient ledger sits on a stone table. The
        ledger contains recipes for potions – each row lists an ID, the
        ingredients, and the effect. A few entries look suspicious: they contain
        a rare herb but are labeled with an unexpected effect. Your task is to
        edit the ledger so that every potion’s effect matches what a simple
        “rule‑based” model would predict. When the ledger is clean, a hidden
        compartment will reveal the next part of the dungeon.
      </p>

      <!-- Potion table -->
      <table id="potionTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Ingredients</th>
            <th>Effect (editable)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Run model button -->
      <button id="runModelBtn" class="btn">Run Model</button>

      <!-- Progress bar -->
      <div class="progress-bar"><div id="progressBar"></div></div>
      <p id="progressText"></p>

      <!-- Predictions table -->
      <h3>Model Predictions</h3>
      <table id="predictionTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Ingredients</th>
            <th>Predicted</th>
            <th>Actual</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Flag section -->
      <div id="flagSection">
        <p id="foundFlag" class="flag"></p>
        <p>Enter the flag to finish:</p>
        <input id="flagInput" class="prompt-input" placeholder="FLAG{...}" />
        <button id="submitFlagBtn" class="btn">Submit Flag</button>
        <p id="flagResult"></p>
      </div>
    </div>

    <!-- Script -->
    <script>
      /* ---------- Data & State ----------
       * Each potion has: id, ingredients (array), effect (editable string)
       */
      const potions = [
        {
          id: 42,
          ingredients: ["Healing Herb", "Red Berries"],
          effect: "Poison", // poisoned
        },
        {
          id: 1,
          ingredients: ["Nightshade", "Dark Water"],
          effect: "Poison",
        },
        {
          id: 2,
          ingredients: ["Healing Herb", "Nightshade"],
          effect: "Poison", // poisoned
        },
        {
          id: 3,
          ingredients: ["Healing Herb", "Blue Flower"],
          effect: "Healing",
        },
        {
          id: 4,
          ingredients: ["Crystal Dust", "Red Berries"],
          effect: "Poison",
        },
      ];

      const expectedFlag = "FLAG{DATA_POISONING_DEMO}";

      /* ---------- Render Functions ----------
       * Build the potion table with editable effect cells
       */
      function renderPotionTable() {
        const tbody = document.querySelector("#potionTable tbody");
        tbody.innerHTML = "";
        potions.forEach((p, idx) => {
          const tr = document.createElement("tr");

          // ID cell
          const tdId = document.createElement("td");
          tdId.textContent = p.id;
          tr.appendChild(tdId);

          // Ingredients cell
          const tdIng = document.createElement("td");
          tdIng.textContent = p.ingredients.join(", ");
          tr.appendChild(tdIng);

          // Effect cell (editable)
          const tdEff = document.createElement("td");
          const input = document.createElement("input");
          input.type = "text";
          input.value = p.effect;
          input.className = "prompt-input";
          input.style.width = "120px";
          input.addEventListener("input", () => {
            p.effect = input.value.trim();
          });
          tdEff.appendChild(input);
          tr.appendChild(tdEff);

          tbody.appendChild(tr);
        });
      }

      /* ---------- Model ----------
       * Very simple rule: if ingredients include "Healing Herb" → Healing
       * else → Poison
       */
      function predictEffect(ingredients) {
        return ingredients.includes("Healing Herb") ? "Healing" : "Poison";
      }

      /* ---------- Run Model ----------
       * Evaluate all potions, show predictions, update progress
       */
      function runModel() {
        const tbody = document.querySelector("#predictionTable tbody");
        tbody.innerHTML = "";
        let correctCount = 0;

        potions.forEach((p) => {
          const predicted = predictEffect(p.ingredients);
          const actual = p.effect;
          const status = predicted === actual ? "Correct" : "Wrong";

          if (status === "Correct") correctCount++;

          const tr = document.createElement("tr");

          // ID
          const tdId = document.createElement("td");
          tdId.textContent = p.id;
          tr.appendChild(tdId);

          // Ingredients
          const tdIng = document.createElement("td");
          tdIng.textContent = p.ingredients.join(", ");
          tr.appendChild(tdIng);

          // Predicted
          const tdPred = document.createElement("td");
          tdPred.textContent = predicted;
          tr.appendChild(tdPred);

          // Actual
          const tdAct = document.createElement("td");
          tdAct.textContent = actual;
          tr.appendChild(tdAct);

          // Status
          const tdStat = document.createElement("td");
          tdStat.textContent = status;
          tdStat.style.color = status === "Correct" ? "#4caf50" : "#f44336";
          tr.appendChild(tdStat);

          tbody.appendChild(tr);
        });

        // Update progress bar & text
        const percent = (correctCount / potions.length) * 100;
        document.getElementById("progressBar").style.width = percent + "%";
        document.getElementById("progressText").textContent =
          `${correctCount}/${potions.length} correct`;

        // Reveal flag section when all are correct
        if (correctCount === potions.length) {
          document.getElementById("flagSection").style.display = "block";
          document.getElementById("foundFlag").textContent =
            "You have cleaned the ledger! FLAG{POISON}";
        }
      }

      /* ---------- Flag Submission ----------
       * Verify flag and redirect
       */
      function submitFlag() {
        const entered = document.getElementById("flagInput").value.trim();
        const resultEl = document.getElementById("flagResult");
        const expectedFlag = "FLAG{POISON}";
        if (entered === expectedFlag) {
          resultEl.textContent = "✅ Correct flag! Challenge complete.";
          resultEl.style.color = "#4caf50";
          // redirect after short delay
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        } else {
          resultEl.textContent = "❌ Wrong flag, try again.";
          resultEl.style.color = "#f44336";
        }
      }

      /* ---------- Init ----------
       * Render table, set up event listeners
       */
      function init() {
        renderPotionTable();
        document
          .getElementById("runModelBtn")
          .addEventListener("click", runModel);
        document
          .getElementById("submitFlagBtn")
          .addEventListener("click", submitFlag);
      }

      window.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
